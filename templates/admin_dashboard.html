<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard - Student Management</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/admin_dashboard.css') }}" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
</head>

<body>
  <main class="main-content">
    <div class="container">
      <div class="admin-title">
        <h1>Admin Dashboard</h1>
      </div>
      <div class="admin-header">
        <div class="admin-logo-title-container">
          <div class="logo-container1">
            <img src="{{ url_for('static', filename='Images/logo1.png') }}" class="logo-img1" alt="Left Logo" />
            <img src="{{ url_for('static', filename='Images/logo2.png') }}" class="logo-img1" alt="Center Logo" />
          </div>
        </div>
        <div class="flex gap-2">
          <button class="btn btn-primary" onclick="exportData()">
            <i class="fas fa-file-export btn-icon"></i> Extract Data
          </button>
          <button class="btn btn-secondary" onclick="location.reload()">
            <i class="fas fa-sync btn-icon"></i> Refresh
          </button>
          <a href="{{ url_for('logout') }}">
            <button class="btn btn-outline">
              <i class="fas fa-sign-out-alt btn-icon"></i> Logout
            </button>
          </a>
        </div>
      </div>

      <div class="flash-messages">
        {% with messages = get_flashed_messages(with_categories=true) %} {% if
        messages %} {% for category, message in messages %}
        <div class="alert alert-{{ category }}">{{ message }}</div>
        {% endfor %} {% endif %} {% endwith %}
      </div>

      <!-- Statistics Cards -->
      <div class="stats-grid">

        <!-- Today's Attendance -->
        <div class="stat-card" data-type="todays_attendance" onclick="openModal('todays_attendance')">
          <div class="stat-card-content">
            <i class="fas fa-calendar-check stat-icon"></i>
            <div class="stat-info">
              <div class="stat-label">Today's Attendance</div>
              <div class="stat-numbers">
                <div class="stat-value">{{ todays_attendance_count or 0 }}</div>
              </div>
            </div>
          </div>
        </div>
        <!-- Total Students -->
        <div class="stat-card" data-type="total" onclick="openModal('total')">
          <div class="stat-card-content">
            <i class="fas fa-users stat-icon"></i>
            <div class="stat-info">
              <div class="stat-label">Total Students</div>
              <div class="stat-numbers">
                <div class="stat-value">{{ total_records or 0 }}</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Single Career Counselling -->
        <div class="stat-card" data-type="single_counselling" onclick="openModal('single_counselling')">
          <div class="stat-card-content">
            <i class="fas fa-user stat-icon"></i>
            <div class="stat-info">
              <div class="stat-label">One to One Career Counselling</div>
              <div class="stat-numbers">
                <div class="stat-value">{{ training_counts.single_completed or 0 }}</div>
                <div class="stat-percentage">
                  {% if total_records and total_records > 0 %}
                  {{ "%.1f"|format((training_counts.single_completed or 0) * 100.0 / total_records) }}%
                  {% else %}
                  0.0%
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Group Career Counselling -->
        <div class="stat-card" data-type="group_counselling" onclick="openModal('group_counselling')">
          <div class="stat-card-content">
            <i class="fas fa-users stat-icon"></i>
            <div class="stat-info">
              <div class="stat-label">Group Career Counselling</div>
              <div class="stat-numbers">
                <div class="stat-value">{{ training_counts.group_completed or 0 }}</div>
                <div class="stat-percentage">
                  {% if total_records and total_records > 0 %}
                  {{ "%.1f"|format((training_counts.group_completed or 0) * 100.0 / total_records) }}%
                  {% else %}
                  0.0%
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- OJT Status -->
        <div class="stat-card" data-type="ojt" onclick="openModal('ojt')">
          <div class="stat-card-content">
            <i class="fas fa-briefcase stat-icon"></i>
            <div class="stat-info">
              <div class="stat-label">OJT Status</div>
              <div class="stat-numbers">
                <div class="stat-value">{{ training_counts.ojt_completed or 0 }}</div>
                <div class="stat-percentage">
                  {% if total_records and total_records > 0 %}
                  {{ "%.1f"|format((training_counts.ojt_completed or 0) * 100.0 / total_records) }}%
                  {% else %}
                  0.0%
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Guest Lecture -->
        <div class="stat-card" data-type="guest_lecture" onclick="openModal('guest_lecture')">
          <div class="stat-card-content">
            <i class="fas fa-chalkboard-teacher stat-icon"></i>
            <div class="stat-info">
              <div class="stat-label">Guest Lecture</div>
              <div class="stat-numbers">
                <div class="stat-value">{{ training_counts.guest_lecture_completed or 0 }}</div>
                <div class="stat-percentage">
                  {% if total_records and total_records > 0 %}
                  {{ "%.1f"|format((training_counts.guest_lecture_completed or 0) * 100.0 / total_records) }}%
                  {% else %}
                  0.0%
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Industrial Visit -->
        <div class="stat-card" data-type="industrial_visit" onclick="openModal('industrial_visit')">
          <div class="stat-card-content">
            <i class="fas fa-industry stat-icon"></i>
            <div class="stat-info">
              <div class="stat-label">Industrial Visit</div>
              <div class="stat-numbers">
                <div class="stat-value">{{ training_counts.industrial_visit_completed or 0 }}</div>
                <div class="stat-percentage">
                  {% if total_records and total_records > 0 %}
                  {{ "%.1f"|format((training_counts.industrial_visit_completed or 0) * 100.0 / total_records) }}%
                  {% else %}
                  0.0%
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Assessment -->
        <div class="stat-card" data-type="assessment" onclick="openModal('assessment')">
          <div class="stat-card-content">
            <i class="fas fa-clipboard-check stat-icon"></i>
            <div class="stat-info">
              <div class="stat-label">Assessment</div>
              <div class="stat-numbers">
                <div class="stat-value">{{ training_counts.assessment_completed or 0 }}</div>
                <div class="stat-percentage">
                  {% if total_records and total_records > 0 %}
                  {{ "%.1f"|format((training_counts.assessment_completed or 0) * 100.0 / total_records) }}%
                  {% else %}
                  0.0%
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Other Training -->
        <div class="stat-card" data-type="other_trainings" onclick="openModal('other_trainings')">
          <div class="stat-card-content">
            <i class="fas fa-book stat-icon"></i>
            <div class="stat-info">
              <div class="stat-label">Post Training Progression</div>
              <div class="stat-numbers">
                <div class="stat-value">{{ training_counts.other_training_completed or 0 }}</div>
                <div class="stat-percentage">
                  {% if total_records and total_records > 0 %}
                  {{ "%.1f"|format((training_counts.other_training_completed or 0) * 100.0 / total_records) }}%
                  {% else %}
                  0.0%
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal -->
      <div id="trainingModal" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h2 id="modalTitle">Students</h2>
            <span class="close">&times;</span>
          </div>
          <div class="modal-body">
            <div class="modal-filters">
              <form id="modalFilterForm">
                <div class="filters-grid">
                  <!-- NEW: Date Filter - ONLY shows for Today's Attendance -->
                  <div class="filter-group" id="dateFilterGroup" style="display: none;">
                    <label class="form-label">Select Date</label>
                    <input type="date" id="modalDate" name="date" class="form-control" />
                  </div>

                  <!-- District Dropdown -->
                  <div class="filter-group">
                    <label class="form-label">District</label>
                    <select id="modalDistrict" name="district" class="form-control form-select">
                      <option value="">All Districts</option>
                      <option value="Bilaspur">Bilaspur</option>
                      <option value="Chamba">Chamba</option>
                      <option value="Hamirpur">Hamirpur</option>
                      <option value="Kangra">Kangra</option>
                      <option value="Kullu">Kullu</option>
                      <option value="Mandi">Mandi</option>
                      <option value="Sirmour">Sirmour</option>
                      <option value="Solan">Solan</option>
                      <option value="Una">Una</option>
                    </select>
                  </div>

                  <!-- Center Dropdown -->
                  <div class="filter-group">
                    <label class="form-label">Center/Block</label>
                    <select id="modalCenter" name="center" class="form-control form-select" disabled>
                      <option value="">All Centers</option>
                    </select>
                  </div>

                  <!-- Other filters -->
                  <div class="filter-group">
                    <label class="form-label">Gender</label>
                    <select class="form-control" name="gender">
                      <option value="">All Genders</option>
                      <option value="Male">Male</option>
                      <option value="Female">Female</option>
                      <option value="Other">Other</option>
                    </select>
                  </div>

                  <div class="filter-group">
                    <label class="form-label">Trade</label>
                    <select class="form-control" name="trade">
                      <option value="">All Trades</option>
                      <option value="Agriculture">Agriculture</option>
                      <option value="Beauty & Wellness">
                        Beauty & Wellness
                      </option>
                      <option value="Plumbing">Plumbing</option>
                      <option value="Food Processing">Food Processing</option>
                      <option value="Automotive">Automotive</option>
                      <option value="Electronics">Electronics</option>
                      <option value="Tourism & Hospitality">
                        Tourism & Hospitality
                      </option>
                      <option value="Retail">Retail</option>
                    </select>
                  </div>
                </div>

                <!-- Gender Statistics Section -->
                <div class="gender-stats" id="genderStats">
                  <div class="gender-stat-card total">
                    <div class="gender-label">Total Students</div>
                    <div class="gender-count" id="totalCount">0</div>
                  </div>
                  <div class="gender-stat-card male">
                    <div class="gender-label">Male Students</div>
                    <div class="gender-count" id="maleCount">0</div>
                    <div class="gender-percentage" id="malePercentage">0%</div>
                  </div>
                  <div class="gender-stat-card female">
                    <div class="gender-label">Female Students</div>
                    <div class="gender-count" id="femaleCount">0</div>
                    <div class="gender-percentage" id="femalePercentage">0%</div>
                  </div>
                  <div class="gender-stat-card other">
                    <div class="gender-label">Other</div>
                    <div class="gender-count" id="otherCount">0</div>
                    <div class="gender-percentage" id="otherPercentage">0%</div>
                  </div>
                </div>
                <div class="filter-actions">
                  <button type="submit" class="btn btn-primary">
                    <i class="fas fa-filter btn-icon"></i> Apply Filters
                  </button>
                  <button type="reset" class="btn btn-outline">
                    Reset Filters
                  </button>
                  <button type="button" id="exportModalDataBtn" class="btn btn-success">
                    <i class="fas fa-file-export btn-icon"></i> Extract Data
                  </button>
                </div>
              </form>
            </div>

            <div class="modal-table-container">
              <table>
                <thead>
                  <tr>
                    <th>CAN ID</th>
                    <th>Student Name</th>
                    <th>Father's Name</th>
                    <th>Mother's Name</th>
                    <th>Batch ID</th>
                    <th>Mobile</th>
                    <th>Religion</th>
                    <th>Category</th>
                    <th>DOB</th>
                    <th>District</th>
                    <th>Center/Block</th>
                    <th>Gender</th>
                    <th>Trade</th>
                    <th>One to One Counselling</th>
                    <th>Group Counselling</th>
                    <th>OJT Status</th>
                    <th>Guest Lecture</th>
                    <th>Industrial Visit</th>
                    <th>Assessment</th>
                    <th>Assessment Date</th>
                    <th>Total Days</th>
                    <th>Attendance</th>
                    <th>Post Training Progression</th>
                    <th>Enrolled School</th>
                    <th>UDSI Code</th>
                    <th>Aadhar</th>
                    <th>Account Number</th>
                    <th>Account Holder</th>
                    <th>IFSC</th>
                  </tr>
                </thead>
                <tbody id="modalTableBody">
                  <!-- Data will be populated here -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
  <footer class="app-footer">
    <div class="footer-content">
      <span>Powered by</span>
      <img src="{{ url_for('static', filename='Images/company_logo.png') }}" alt="VALEUR FABTEX Logo"
        class="footer-logo-img" />
    </div>
  </footer>

  <script>
    const centerData = {
      Bilaspur: ["Jhandutta", "Sadar", "Shri Naina Devi Ji,],
      Chamba: [
        "Banikhet",
        "Chamba",
        "Chowari",
        "Garola",
        "Gehra",
        "Hardaspura",
        "Kalhel",
        "Kiani",
        "Mehla",
        "Salooni",
        "Sihunta",
        "Sundla",
        "Tissa",
      ],
      Hamirpur: ["Hamirpur"],
      Kangra: ["Baijnath", "Nurpur", "Panchrukhi", "Rait"],
      Kullu: ["Anni", "Banjar", "Kullu-1", "Kullu-2", "Naggar", "Nirmand"],
      Mandi: ["Sadar-2", "Seraj-2"],
      Sirmour: [
        "Bakras",
        "Dadahu",
        "Narag",
        "Paonta Sahib",
        "Rajgarh",
        "Sataun",
        "Shillai",
        "Surla",
        "Majra",
      ],
      Solan: [
        "Arki",
        "Dharampur",
        "Dhundan",
        "Kandaghat",
        "Nalagarh",
        "Ramshehar",
      ],
      Una: ["Amb", "Gagret-1", "Haroli", "Jol", "Una"],
    };

    // Function to update centers in modal based on selected district
    function updateModalCenters() {
      const districtSelect = document.getElementById("modalDistrict");
      const centerSelect = document.getElementById("modalCenter");
      const selectedDistrict = districtSelect.value;

      // Clear existing options
      centerSelect.innerHTML = '<option value="">All Centers</option>';
      centerSelect.disabled = !selectedDistrict;

      if (selectedDistrict && centerData[selectedDistrict]) {
        centerSelect.disabled = false;
        centerData[selectedDistrict].forEach((center) => {
          const option = document.createElement("option");
          option.value = center;
          option.textContent = center;
          centerSelect.appendChild(option);
        });
      }
    }

    // Modal functionality
    function openModal(type) {
      const modal = document.getElementById("trainingModal");
      const modalTitle = document.getElementById("modalTitle");
      const dateFilterGroup = document.getElementById("dateFilterGroup");
      const dateInput = document.getElementById("modalDate");

      // Set modal title based on type
      const titles = {
        total: "All Students",
        single_counselling: "Students with Single Career Counselling Completed",
        group_counselling: "Students with Group Career Counselling Completed",
        ojt: "Students with OJT Completed",
        guest_lecture: "Students with Guest Lecture Completed",
        industrial_visit: "Students with Industrial Visit Completed",
        assessment: "Students with Assessment Completed",
        other_trainings: "Students with Other Training Completed",
        todays_attendance: "Students Attendance by Date",
      };

      modalTitle.textContent = titles[type] || "Students";
      modal.dataset.type = type;

      // Show/hide date filter ONLY for attendance
      if (type === "todays_attendance") {
        dateFilterGroup.style.display = "block";
        const today = new Date().toISOString().split('T')[0];
        dateInput.value = today;
      } else {
        dateFilterGroup.style.display = "none";
        dateInput.value = "";
      }

      // Reset form and load initial data
      document.getElementById("modalFilterForm").reset();
      
      // Restore date if it was for attendance
      if (type === "todays_attendance") {
        const today = new Date().toISOString().split('T')[0];
        dateInput.value = today;
      }

      document.getElementById("modalCenter").innerHTML =
        '<option value="">All Centers</option>';
      document.getElementById("modalCenter").disabled = true;

      // Reset gender stats to loading state
      updateGenderStats({
        total: 0,
        male: { count: 0, percentage: 0 },
        female: { count: 0, percentage: 0 },
        other: { count: 0, percentage: 0 }
      });

      loadModalData(type);

      // Show modal
      modal.style.display = "block";
    }

    function closeModal() {
      document.getElementById("trainingModal").style.display = "none";
    }

    // Function to update gender statistics
    function updateGenderStats(genderStats) {
      // Update the UI with the provided statistics
      document.getElementById('totalCount').textContent = genderStats.total;
      document.getElementById('maleCount').textContent = genderStats.male.count;
      document.getElementById('femaleCount').textContent = genderStats.female.count;
      document.getElementById('otherCount').textContent = genderStats.other.count;

      // Update percentages
      document.getElementById('malePercentage').textContent = `${genderStats.male.percentage}%`;
      document.getElementById('femalePercentage').textContent = `${genderStats.female.percentage}%`;
      document.getElementById('otherPercentage').textContent = `${genderStats.other.percentage}%`;
    }

    function loadModalData(
      type,
      district = "",
      center = "",
      gender = "",
      trade = "",
      date = ""
    ) {
      const tableBody = document.getElementById("modalTableBody");
      tableBody.innerHTML =
        '<tr><td colspan="29" class="text-center">Loading data...</td></tr>';

      // Reset gender stats while loading
      updateGenderStats({
        total: 0,
        male: { count: 0, percentage: 0 },
        female: { count: 0, percentage: 0 },
        other: { count: 0, percentage: 0 }
      });

      // AJAX request to get filtered data (with date parameter)
      fetch(
        `/admin_dashboard/modal_data?type=${type}&district=${district}&center=${center}&gender=${gender}&trade=${trade}&date=${date}`
      )
        .then((response) => {
          if (!response.ok) {
            throw new Error("Network response was not ok");
          }
          return response.json();
        })
        .then((responseData) => {
          const { students, gender_stats } = responseData;

          if (students.length === 0) {
            tableBody.innerHTML =
              '<tr><td colspan="29" class="text-center">No records found</td></tr>';
            // Update gender stats with zero values
            updateGenderStats({
              total: 0,
              male: { count: 0, percentage: 0 },
              female: { count: 0, percentage: 0 },
              other: { count: 0, percentage: 0 }
            });
            return;
          }

          // Update gender statistics
          updateGenderStats(gender_stats);

          let html = "";
          students.forEach((student) => {
            html += `
                            <tr>
                                <!-- Students Data -->
                                <td>${student.can_id || ""}</td>
                                <td>${student.student_name || ""}</td>
                                <td>${student.father_name || ""}</td>
                                <td>${student.mother_name || ""}</td>
                                <td>${student.batch_id || ""}</td>
                                <td>${student.mobile || ""}</td>
                                <td>${student.religion || ""}</td>
                                <td>${student.category || ""}</td>
                                <td>${student.dob || ""}</td>
                                <td>${student.district || ""}</td>
                                <td>${student.center || ""}</td>
                                <td>${student.gender || ""}</td>

                                <!-- Training Data -->
                                <td>${student.trade || ""}</td>
                                <td>
                                    <span class="status-badge ${student.single_counselling === "Completed"
                ? "status-completed"
                : "status-not-completed"
              }">
                                        ${student.single_counselling ||
              "Not Completed"
              }
                                    </span>
                                </td>
                                <td>
                                    <span class="status-badge ${student.group_counselling === "Completed"
                ? "status-completed"
                : "status-not-completed"
              }">
                                        ${student.group_counselling ||
              "Not Completed"
              }
                                    </span>
                                </td>
                                <td>
                                    <span class="status-badge ${student.ojt === "Completed"
                ? "status-completed"
                : "status-not-completed"
              }">
                                        ${student.ojt || "Not Completed"}
                                    </span>
                                </td>
                                <td>
                                    <span class="status-badge ${student.guest_lecture === "Completed"
                ? "status-completed"
                : "status-not-completed"
              }">
                                        ${student.guest_lecture ||
              "Not Completed"
              }
                                    </span>
                                </td>
                                <td>
                                    <span class="status-badge ${student.industrial_visit === "Completed"
                ? "status-completed"
                : "status-not-completed"
              }">
                                        ${student.industrial_visit ||
              "Not Completed"
              }
                                    </span>
                                </td>
                                <td>
                                    <span class="status-badge ${student.assessment === "Completed"
                ? "status-completed"
                : "status-not-completed"
              }">
                                        ${student.assessment || "Not Completed"}
                                    </span>
                                </td>
                                <td>${student.assessment_date || ""}</td>
                                <td>${student.total_days || 0}</td>
                                <td>${student.attendance || 0}</td>

                                <td>
                                    <span class="status-badge ${student.other_trainings &&
                student.other_trainings !==
                "Not Completed"
                ? "status-completed"
                : "status-not-completed"
              }">
                                        ${student.other_trainings ||
              "Not Completed"
              }
                                    </span>
                                </td>
                                <!-- Bank Data -->
                                <td>${student.school_enrollment || ""}</td>
                                <td>${student.udsi || ""}</td>
                                <td>${student.aadhar || ""}</td>
                                <td>${student.account_number || ""}</td>
                                <td>${student.account_holder || ""}</td>
                                <td>${student.ifsc || ""}</td>
                            </tr>
                        `;
          });

          tableBody.innerHTML = html;
        })
        .catch((error) => {
          console.error("Error:", error);
          tableBody.innerHTML =
            '<tr><td colspan="29" class="text-center">Error loading data</td></tr>';
          // Reset gender stats on error
          updateGenderStats({
            total: 0,
            male: { count: 0, percentage: 0 },
            female: { count: 0, percentage: 0 },
            other: { count: 0, percentage: 0 }
          });
        });
    }

    // Initialize the form when DOM is loaded
    document.addEventListener("DOMContentLoaded", function () {
      // Modal form district-center relationship
      document
        .getElementById("modalDistrict")
        .addEventListener("change", updateModalCenters);

      // Flash messages timeout
      const flashMessages = document.querySelectorAll(".alert");
      flashMessages.forEach((message) => {
        setTimeout(() => {
          message.style.opacity = "0";
          setTimeout(() => message.remove(), 500);
        }, 3000);
      });

      // Modal functionality
      document.querySelector(".close").addEventListener("click", closeModal);

      window.addEventListener("click", function (event) {
        const modal = document.getElementById("trainingModal");
        if (event.target === modal) {
          closeModal();
        }
      });

      document
        .getElementById("modalFilterForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          const type = document.getElementById("trainingModal").dataset.type;
          const district = this.elements.district.value;
          const center = this.elements.center.value;
          const gender = this.elements.gender.value;
          const trade = this.elements.trade.value;
          const date = this.elements.date ? this.elements.date.value : "";

          loadModalData(type, district, center, gender, trade, date);
        });

      // Debugging
      console.log("Initialization complete");
    });

    // Export Modal Data Functionality
    document
      .getElementById("exportModalDataBtn")
      .addEventListener("click", function () {
        const form = document.getElementById("modalFilterForm");
        const type = document.getElementById("trainingModal").dataset.type;

        // Build URL with filters
        const url = `/export_filtered_data?type=${type}&district=${form.district.value}&center=${form.center.value}&gender=${form.gender.value}&trade=${form.trade.value}`;

        // Trigger download
        window.location.href = url;
      });

    function exportData() {
      // Get current filters from the modal (if open)
      let filters = {};
      const modal = document.getElementById("trainingModal");

      if (modal.style.display === "block") {
        // If modal is open, use modal filters
        const form = document.getElementById("modalFilterForm");
        filters = {
          type: modal.dataset.type,
          district: form.district.value,
          center: form.center.value,
          gender: form.gender.value,
          trade: form.trade.value,
          other_trainings:
            form.querySelector('[name="other_trainings"]')?.value || "",
        };
      } else {
        // Otherwise use empty/default filters
        filters = {
          type: "total",
          district: "",
          center: "",
          gender: "",
          trade: "",
          other_trainings: "",
        };
      }

      // Build URL with filters using URLSearchParams for proper encoding
      const params = new URLSearchParams();
      for (const [key, value] of Object.entries(filters)) {
        if (value) params.append(key, value);
      }

      // Trigger download
      window.location.href = `/export_filtered_data?${params.toString()}`;
    }
  </script>
</body>

</html>
